<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin LUSSON | Gestión de Imagen</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; background: #fdf2f5; margin: 0; padding: 20px; }
        .admin-container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        h1 { color: #f8bbd0; text-align: center; }
        .upload-card { border: 2px dashed #f8bbd0; padding: 20px; border-radius: 15px; margin-bottom: 30px; text-align: center; }
        input[type="file"] { margin: 15px 0; }
        button { background: #f8bbd0; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        button:hover { background: #ffdeeb; color: #333; }
        .progress-bar { width: 0%; height: 10px; background: #25d366; border-radius: 5px; margin-top: 10px; transition: 0.3s; }
        .preview-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
        .preview-item { border: 1px solid #eee; padding: 10px; border-radius: 10px; position: relative; }
        .preview-item img { width: 100%; border-radius: 8px; }
        .btn-delete { background: #ff4d4d; padding: 5px 10px; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="admin-container">
    <h1>Administrador LUSSON</h1>

    <div class="upload-card">
        <h3>Subir Nueva Imagen al Carrusel</h3>
        <input type="file" id="file-banner" accept="image/*">
        <br>
        <input type="number" id="order-banner" placeholder="Orden (ej: 1)" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
        <button onclick="uploadImage('banner')">Subir al Carrusel</button>
        <div id="progress-banner" class="progress-bar"></div>
    </div>

    <div class="upload-card">
        <h3>Actualizar Combos o Promociones</h3>
        <select id="type-static" style="padding: 8px; border-radius: 5px;">
            <option value="combos">Cuadro de Combos</option>
            <option value="promos">Cuadro de Promociones</option>
        </select>
        <input type="file" id="file-static" accept="image/*">
        <button onclick="uploadImage('static')">Actualizar Imagen</button>
        <div id="progress-static" class="progress-bar"></div>
    </div>

    <hr>
    <h3>Imágenes actuales en Inicio</h3>
    <div id="admin-list" class="preview-list"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCMCFn8zuekM5rIh6Uq02zu_ypblsJonuo",
        authDomain: "lusson-web.firebaseapp.com",
        projectId: "lusson-web",
        storageBucket: "lusson-web.appspot.com", // Asegúrate que termine en .appspot.com
        messagingSenderId: "445073966036",
        appId: "1:445073966036:web:f6c56d465f68ace86a4c41"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const storage = firebase.storage();

    async function uploadImage(mode) {
        const fileInput = mode === 'banner' ? document.getElementById('file-banner') : document.getElementById('file-static');
        const progressBar = mode === 'banner' ? document.getElementById('progress-banner') : document.getElementById('progress-static');
        const file = fileInput.files[0];
        
        if (!file) return alert("Selecciona un archivo primero");

        // 1. Crear referencia en Storage
        const storageRef = storage.ref(`inicio/${Date.now()}_${file.name}`);
        const uploadTask = storageRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = progress + '%';
            }, 
            (error) => alert("Error al subir: " + error.message), 
            async () => {
                // 2. Obtener la URL de descarga
                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                
                if (mode === 'banner') {
                    const orden = document.getElementById('order-banner').value || 1;
                    await db.collection("banners").add({
                        img: downloadURL,
                        orden: parseInt(orden)
                    });
                } else {
                    const docId = document.getElementById('type-static').value;
                    await db.collection("config_inicio").doc(docId).set({
                        img: downloadURL
                    });
                }
                
                alert("¡Imagen actualizada con éxito!");
                progressBar.style.width = '0%';
                fileInput.value = '';
            }
        );
    }

    // Listar imágenes para borrar
    db.collection("banners").orderBy("orden", "asc").onSnapshot(snap => {
        const list = document.getElementById('admin-list');
        list.innerHTML = '';
        snap.forEach(doc => {
            const data = doc.data();
            list.innerHTML += `
                <div class="preview-item">
                    <img src="${data.img}">
                    <button class="btn-delete" onclick="deleteBanner('${doc.id}')">Borrar</button>
                </div>
            `;
        });
    });

    async function deleteBanner(id) {
        if(confirm("¿Borrar esta imagen?")) await db.collection("banners").doc(id).delete();
    }
</script>

</body>
</html>

